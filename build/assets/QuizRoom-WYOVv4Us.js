import{j as e}from"./ui-vendor-DeL-jnW0.js";import{h as ae,u as oe,r as l}from"./react-vendor-BRxAXmoz.js";import{A as ne,i as N}from"./index-CtH3Z_vz.js";import{l as ie}from"./socket-vendor-TjCxX7sJ.js";import{s as n,C as f,S as ce,T as le,d as G,B as y,L as B,c as b,e as S,A as T,f as M,P as ue,g as U,h as W,i as de}from"./antd-vendor-DXVleyxb.js";const he="http://localhost:5000",i=ie(he,{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,timeout:1e4,transports:["websocket","polling"],withCredentials:!0,path:"/socket.io/"});i.on("connect",()=>{console.log("Socket connected successfully")});i.on("connect_error",a=>{console.error("Socket connection error:",a)});const{Title:z}=le,qe=()=>{var _,O;const{code:a}=ae(),h=oe(),{auth:o}=l.useContext(ne),[u,K]=l.useState({createdBy:null}),[E,L]=l.useState(null),[$,I]=l.useState(!0),[j,J]=l.useState(!1),[me,pe]=l.useState(null),[m,w]=l.useState([]),[V,Q]=l.useState(!1),[g,F]=l.useState(0),[C,k]=l.useState([]),[d,A]=l.useState(""),[P,R]=l.useState(30),[q,D]=l.useState(!1),[H,X]=l.useState(0),[fe,Y]=l.useState(!1),Z=async()=>{var s,t;try{I(!0);const c=(await N.get(`http://localhost:5000/api/quiz/${a}`)).data;if(!c)throw new Error("Quiz not found");const x=c.creatorName===o.username;console.log("=== Quiz Data Debug ==="),console.log("Quiz Data:",c),console.log("Current username:",o.username),console.log("Quiz creatorName:",c.creatorName),console.log("Is creator?",x),K(c),k(c.questions||[]),Q(c.status==="active"),J(x),console.log(c.participants),c.participants&&w(c.participants),console.log("Creator status set to:",x),L(null)}catch(r){console.error("Failed to fetch quiz details:",r);const c=((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to load quiz";L(c),n.error(c)}finally{I(!1)}};l.useEffect(()=>{if(!o.userId){n.error("Please login to join the quiz"),h("/login");return}a&&Z()},[a,o.userId,h]),l.useEffect(()=>(i.connected||i.connect(),i.emit("join-room",{code:a,username:o.username,userId:o.userId}),i.on("quiz-ended",s=>{console.log("Quiz ended event received",s),Y(!0),localStorage.setItem(`quiz_${a}_final_score`,H),n.info("Quiz has been ended by the host. Redirecting to leaderboard..."),setTimeout(()=>{h(`/leaderboard/${a}`)},1500)}),i.on("quiz-error",s=>{n.error(s.message)}),i.on("player-joined",s=>{w(t=>t.some(c=>c.userId===s.userId)?t:[...t,s]),n.info(`${s.username} joined the quiz`)}),i.on("player-list",s=>{w(s)}),i.on("quiz-started",s=>{var t;Q(!0),s.questions&&(k(s.questions),F(0),R(((t=s.questions[0])==null?void 0:t.timeLimit)||30))}),()=>{i.emit("leave-room",{code:a,username:o.username,userId:o.userId}),i.off("player-joined"),i.off("player-list"),i.off("quiz-started"),i.off("quiz-ended"),i.off("quiz-error")}),[a,o.username,o.userId,h,H]);const ee=async()=>{var s,t;if(!j||u.creatorName!==o.username){n.error("Only the quiz creator can start the quiz");return}try{const r=await N.post("/api/quiz/start",{code:a,creatorName:o.username});r.data.success&&(i.emit("start-quiz",{code:a}),Q(!0),k(r.data.questions),n.success("Quiz started successfully!"))}catch(r){console.error("Failed to start quiz:",r),n.error(((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to start quiz")}},se=async()=>{if(!d||Array.isArray(d)&&d.length===0){n.warning("Please select an answer");return}I(!0);try{const s=await N.post("/api/quiz/submit-answer",{code:a,userId:o.userId,questionIndex:g,answer:Array.isArray(d)?d.sort().join(","):d});D(!0),s.data.success&&(X(s.data.currentScore),s.data.correct?n.success(`Correct! You earned ${s.data.points} points!`):n.error(`Incorrect. The correct answer was: ${s.data.correctAnswer}`),g<C.length-1?setTimeout(()=>{var t;F(r=>r+1),A(""),D(!1),R(((t=C[g+1])==null?void 0:t.timeLimit)||30)},2e3):(n.info("You've completed all questions! Waiting for the host to end the quiz..."),i.emit("player-completed",{code:a,userId:o.userId,username:o.username,finalScore:s.data.currentScore})))}catch{n.error("Failed to submit answer")}finally{I(!1)}},te=async()=>{var s,t,r,c,x;if(!j){n.error("Only the quiz creator can end the quiz");return}try{const p=await N.post(`/api/quiz/${a}/end`,{code:a,createdBy:u.createdBy});p.data.success&&(i.emit("end-quiz",{code:a,createdBy:u.createdBy,finalScores:p.data.finalScores}),Y(!0),n.success("Quiz ended successfully"))}catch(p){console.error("Failed to end quiz:",p),((s=p.response)==null?void 0:s.status)===403?n.error("Only quiz creator can end the quiz"):((t=p.response)==null?void 0:t.status)===400?n.error("Quiz is already completed"):((r=p.response)==null?void 0:r.status)===404?n.error("Quiz not found"):n.error(((x=(c=p.response)==null?void 0:c.data)==null?void 0:x.error)||"Failed to end quiz")}h(`/leaderboard/${a}`)},v=C[g]||{};if($)return e.jsx("div",{className:"quiz-container",children:e.jsx(f,{className:"quiz-card",children:e.jsxs("div",{style:{textAlign:"center",padding:"40px"},children:[e.jsx(ce,{size:"large"}),e.jsx(z,{level:4,style:{marginTop:"20px"},children:"Loading Quiz..."})]})})});if(E)return e.jsx("div",{className:"quiz-container",children:e.jsx(f,{className:"quiz-card",children:e.jsx(G,{status:"error",title:"Failed to load quiz",subTitle:E,extra:[e.jsx(y,{type:"primary",onClick:()=>h("/home"),children:"Back Home"},"home")]})})});if(!u)return e.jsx("div",{className:"quiz-container",children:e.jsx(f,{className:"quiz-card",children:e.jsx(G,{status:"404",title:"Quiz Not Found",subTitle:"The quiz you're looking for doesn't exist.",extra:[e.jsx(y,{type:"primary",onClick:()=>h("/home"),children:"Back Home"},"home")]})})});const re=()=>!j||u.creatorName!==o.username?null:e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx(M,{message:"Host Controls",description:m.length<2?"Please wait for at least 2 players to join before starting the quiz.":"You can now start the quiz. All players are ready!",type:m.length<2?"warning":"success",showIcon:!0,style:{marginBottom:"20px"}}),e.jsx(y,{type:"primary",size:"large",block:!0,onClick:ee,disabled:m.length<2,style:{height:"50px",fontSize:"18px",backgroundColor:m.length<2?"#d9d9d9":"#1890ff"},icon:e.jsx(de,{}),children:m.length<2?"Waiting for Players...":"Start Quiz Now"})]});return V?e.jsx("div",{className:"quiz-container",children:e.jsx(f,{className:"quiz-card",title:e.jsxs(b,{align:"center",style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(z,{level:3,children:u.title}),e.jsx(b,{children:j&&e.jsx(y,{type:"primary",danger:!0,onClick:te,disabled:u.status==="completed",children:"End Quiz"})})]}),children:e.jsxs("div",{className:"quiz-content",children:[e.jsxs("div",{className:"timer-section",children:[e.jsx(ue,{percent:P/30*100,status:"active",showInfo:!1}),e.jsxs("div",{className:"time-display",children:["Time Left: ",P,"s"]})]}),e.jsxs("div",{className:"question-card",children:[e.jsxs("div",{className:"question-header",children:[e.jsxs(z,{level:4,children:["Question ",g+1," of ",C.length]}),e.jsx(z,{level:3,children:v.text})]}),v.type==="single"&&e.jsx(U.Group,{onChange:s=>A(s.target.value),value:d,disabled:q,className:"options-container",children:(_=v.options)==null?void 0:_.map((s,t)=>e.jsx(U,{value:s,children:e.jsx(f,{hoverable:!q,className:`option-card ${d===s?"selected":""}`,children:s})},t))}),v.type==="multiple"&&e.jsx(W.Group,{onChange:A,value:d,disabled:q,className:"options-container",children:(O=v.options)==null?void 0:O.map((s,t)=>e.jsx(W,{value:s,children:e.jsx(f,{hoverable:!q,className:`option-card ${d!=null&&d.includes(s)?"selected":""}`,children:s})},t))})]}),e.jsx("div",{className:"submit-section",children:e.jsx(y,{type:"primary",size:"large",onClick:se,disabled:q||!d,loading:$,children:"Submit Answer"})})]})})}):e.jsxs("div",{className:"quiz-container",children:[e.jsx(f,{title:e.jsxs(b,{children:[e.jsx(z,{level:3,children:u.title||"Quiz Lobby"}),e.jsxs(S,{color:"blue",children:["Code: ",a]}),o.userId===u.createdBy&&e.jsx(S,{color:"gold",children:"You are the host"})]}),className:"quiz-card",extra:e.jsxs(b,{children:[e.jsxs(S,{color:"cyan",children:["Created by: ",u.creatorName]}),e.jsx(T.Group,{maxCount:2,children:m.map(s=>{var t,r;return e.jsx(T,{children:(r=(t=s.username)==null?void 0:t[0])==null?void 0:r.toUpperCase()},s.userId)})}),e.jsxs("span",{children:["Players: ",m.length]})]}),children:e.jsxs("div",{className:"quiz-lobby",children:[re(),e.jsxs("div",{className:"players-list",children:[e.jsx(z,{level:4,children:"Players in Lobby"}),e.jsx(B,{dataSource:m,renderItem:s=>{var t,r;return e.jsx(B.Item,{children:e.jsx(B.Item.Meta,{avatar:e.jsx(T,{style:{backgroundColor:s.userId===u.createdBy?"#f56a00":"#1890ff"},children:(r=(t=s.username)==null?void 0:t[0])==null?void 0:r.toUpperCase()}),title:e.jsxs(b,{children:[s.username,s.userId===o.userId&&e.jsx(S,{color:"green",children:"You"}),s.userId===u.createdBy&&e.jsx(S,{color:"orange",children:"Host"})]})})})}})]}),(!j||o.userId!==u.createdBy)&&e.jsx(M,{message:"Waiting for host to start the quiz...",type:"info",showIcon:!0})]})}),e.jsx(y,{type:"primary",onClick:()=>h("/home"),children:"Back to Home"},"home")]})};export{qe as default};
